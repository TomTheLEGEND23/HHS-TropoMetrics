<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TropoMetrics Weather API</title>
    <style>
        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
        }
        pre {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #3e3e42;
        }
        .header {
            color: #4ec9b0;
            margin-bottom: 20px;
            padding: 10px;
            background: #252526;
            border-radius: 8px;
            border-left: 4px solid #4ec9b0;
        }
        .loading {
            color: #dcdcaa;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>üåæ TropoMetrics Weather Data API</h2>
        <p>Real-time weather data for agricultural sector</p>
    </div>
    <div class="loading">‚è≥ Loading weather data...</div>
    <pre id="output"></pre>
    
    <script>
        // TropoMetrics Weather Data API
        // This endpoint returns the current weather data in JSON format
        
        const test_user = {
            latitude: -5.013,
            longitude: -58.381
        };

        async function getWeatherData() {
            const coordinates = {
                latitude: test_user.latitude,
                longitude: test_user.longitude
            };

            const api_request = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(coordinates.latitude)}&longitude=${encodeURIComponent(coordinates.longitude)}&daily=temperature_2m_max,temperature_2m_min,daylight_duration&hourly=precipitation,relative_humidity_2m,soil_moisture_27_to_81cm&current=temperature_2m&timezone=Europe%2FBerlin`;

            try {
                const response = await fetch(api_request);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch weather data from Open-Meteo API');
                }

                const weather_data = await response.json();
                
                // Calculate derived values (same logic as the main page)
                const date = new Date();
                let time_hour = date.getHours();
                if (time_hour > 0) {
                    const rest = time_hour % 6;
                    time_hour -= rest;
                }

                const time_line_graph = 24 * 5 + time_hour;
                let precipitation_5days = [];
                let amount = 0;
                let current_date = new Date(date);
                
                for (let i = time_hour; i < time_line_graph && i < weather_data.hourly.precipitation.length; i++) {
                    amount += weather_data.hourly.precipitation[i];
                    if ((i % 6) == 0 && i != 0) {
                        precipitation_5days.push({
                            period_hours: 6,
                            precipitation_mm: parseFloat(amount.toFixed(2)),
                            date: current_date.toISOString().split('T')[0]
                        });
                        amount = 0;
                    }
                    
                    // Advance date every 24 hours
                    if (i % 24 === 0 && i !== 0) {
                        current_date.setDate(current_date.getDate() + 1);
                    }
                }

                // Calculate irrigation advice
                let soil_moisture_27_to_81cm = weather_data.hourly.soil_moisture_27_to_81cm[0];
                let irrigation_advice = soil_moisture_27_to_81cm <= 0.14 ? "Geef water" : "Water geven is nu niet nodig";

                // Build structured response
                const api_response = {
                    metadata: {
                        service: "TropoMetrics Weather API",
                        version: "1.0.0",
                        timestamp: new Date().toISOString(),
                        location: {
                            latitude: coordinates.latitude,
                            longitude: coordinates.longitude,
                            timezone: "Europe/Berlin"
                        },
                        source: "Open-Meteo API",
                        endpoint: "/data"
                    },
                    current: {
                        temperature_celsius: weather_data.current.temperature_2m,
                        temperature_fahrenheit: (weather_data.current.temperature_2m * 9/5 + 32).toFixed(1),
                        timestamp: weather_data.current.time
                    },
                    daily: {
                        temperature_min_celsius: Math.min(...weather_data.daily.temperature_2m_min),
                        temperature_max_celsius: Math.max(...weather_data.daily.temperature_2m_max),
                        daylight_duration_seconds: weather_data.daily.daylight_duration[0],
                        daylight_hours: Math.round(weather_data.daily.daylight_duration[0] / 3600),
                        daylight_minutes: Math.round((weather_data.daily.daylight_duration[0] % 3600) / 60),
                        daylight_formatted: `${Math.round(weather_data.daily.daylight_duration[0] / 3600)}h ${Math.round((weather_data.daily.daylight_duration[0] % 3600) / 60)}m`
                    },
                    moisture: {
                        soil_moisture_27_to_81cm_percentage: parseFloat((soil_moisture_27_to_81cm * 100).toFixed(2)),
                        soil_moisture_raw: soil_moisture_27_to_81cm,
                        relative_humidity_percentage: weather_data.hourly.relative_humidity_2m[0],
                        timestamp: new Date().toISOString()
                    },
                    irrigation: {
                        advice: irrigation_advice,
                        advice_english: soil_moisture_27_to_81cm <= 0.14 ? "Give water" : "Watering not needed now",
                        needs_water: soil_moisture_27_to_81cm <= 0.14,
                        threshold: 0.14,
                        current_level: soil_moisture_27_to_81cm
                    },
                    forecast: {
                        precipitation_5day: precipitation_5days,
                        total_precipitation_mm: parseFloat(precipitation_5days.reduce((sum, p) => sum + p.precipitation_mm, 0).toFixed(2)),
                        forecast_periods: precipitation_5days.length
                    },
                    raw_data: {
                        note: "Full hourly and daily data from Open-Meteo API",
                        daily: weather_data.daily,
                        hourly_sample: {
                            precipitation_first_24h: weather_data.hourly.precipitation.slice(0, 24),
                            relative_humidity_first_24h: weather_data.hourly.relative_humidity_2m.slice(0, 24),
                            soil_moisture_first_24h: weather_data.hourly.soil_moisture_27_to_81cm.slice(0, 24)
                        }
                    }
                };

                // Output JSON
                document.querySelector('.loading').style.display = 'none';
                document.getElementById('output').textContent = JSON.stringify(api_response, null, 2);
                
            } catch (error) {
                const error_response = {
                    error: true,
                    message: error.message,
                    timestamp: new Date().toISOString(),
                    service: "TropoMetrics Weather API"
                };
                document.querySelector('.loading').style.display = 'none';
                document.getElementById('output').textContent = JSON.stringify(error_response, null, 2);
            }
        }

        // Fetch and display data when page loads
        getWeatherData();
    </script>
</body>
</html>
